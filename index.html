<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì—°ì²œêµ° ê´€ê´‘ì§€ â€” ì¶”ì²œ ì½”ìŠ¤ (ë¹¨ê°„ ê²½ë¡œ + ì´ ì‹œê°„)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{--primary:#0B63B8;--muted:#F1F6F9;--card:#fff;--text:#222}
  *{box-sizing:border-box} body{font-family:"Noto Sans KR",sans-serif;margin:0;background:#f7fbff;color:var(--text)}
  header{background:linear-gradient(135deg,var(--primary),#2E8B57);color:#fff;padding:20px 16px;text-align:center}
  header h1{margin:0;font-size:1.2rem}
  .wrap{max-width:1200px;margin:18px auto;padding:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,0.08)}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .layout{display:grid;grid-template-columns:1fr 380px;gap:12px}
  #map{height:680px;border-radius:12px;border:1px solid rgba(0,0,0,0.06)}
  .panel{background:var(--card);padding:12px;border-radius:12px;height:680px;overflow:auto;border:1px solid rgba(0,0,0,0.04)}
  .search{display:flex;gap:8px;margin-bottom:10px}
  input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef9}
  .place{display:flex;gap:10px;padding:8px;border-radius:8px;border:1px solid #f0f4fb;align-items:center;margin-bottom:8px;cursor:pointer}
  .place img{width:84px;height:56px;object-fit:cover;border-radius:6px}
  .place .meta{flex:1}
  .place .meta b{display:block;color:var(--primary)}
  .small{font-size:13px;color:#666}
  .route-list li{padding:8px;background:var(--muted);border-radius:8px;margin-bottom:6px;list-style:none}
  .mode-select{padding:8px;border-radius:8px;border:1px solid #eee}
  #route-summary { margin-top:10px; padding:10px; background:#fff9f9; border-radius:8px; border:1px solid #ffe6e6; }
  footer{max-width:1200px;margin:18px auto;text-align:center;color:#666;font-size:13px}
  @media(max-width:980px){.layout{grid-template-columns:1fr} .panel{height:auto} #map{height:420px}}
</style>
</head>
<body>
<header>
  <h1>ì—°ì²œêµ° ê´€ê´‘ì§€ â€” ëª¨ë“  ê´€ê´‘ì§€ í‘œì‹œ + ì¶”ì²œ ì½”ìŠ¤</h1>
  <div style="font-size:13px;opacity:.95">ëª¨ë“  ê´€ê´‘ì§€ëŠ” ì´ˆê¸°ì— ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤. ì²´í¬í•´ì„œ ì¶”ì²œ ëŒ€ìƒ ì„ íƒ í›„ ê²½ë¡œ ìƒì„±í•˜ì„¸ìš”.</div>
</header>

<div class="wrap">
  <div class="controls">
    <button id="btn-select-all" class="btn ghost">ì „ì²´ì„ íƒ</button>
    <button id="btn-clear-all" class="btn ghost">ì„ íƒí•´ì œ</button>

    <label style="display:flex;gap:8px;align-items:center">
      <span class="small">ì´ë™ìˆ˜ë‹¨</span>
      <select id="mode" class="mode-select">
        <option value="car">ìì°¨ (ìë™ì°¨)</option>
        <option value="bike">ìì „ê±°</option>
        <option value="walk">ë„ë³´</option>
      </select>
    </label>

    <button id="btn-recommend" class="btn" disabled>ì¶”ì²œ ë£¨íŠ¸ ìƒì„±</button>
    <button id="btn-clear-route" class="btn ghost">ë£¨íŠ¸ ì§€ìš°ê¸°</button>

    <label style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <select id="start-mode" style="padding:8px;border-radius:8px;border:1px solid #eee">
        <option value="pick">ì„ íƒí•œ ì¥ì†Œ ì¤‘ì—ì„œ ì‹œì‘</option>
        <option value="current">í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì‹œì‘</option>
      </select>
    </label>

    <label style="display:flex;gap:6px;align-items:center">
      <span class="small">ì‹œì‘ì§€:</span>
      <select id="start-select" style="padding:8px;border-radius:8px;border:1px solid #eee"></select>
    </label>
  </div>

  <div class="layout">
    <div id="map"></div>

    <aside class="panel">
      <div class="search">
        <input id="q" placeholder="ê²€ìƒ‰ (ì¥ì†Œëª… / ì£¼ì†Œ í¬í•¨)"/>
        <button id="btn-search" class="btn ghost">ê²€ìƒ‰</button>
      </div>

      <h3 style="margin:6px 0">ê´€ê´‘ì§€ ëª©ë¡ (ì²´í¬í•´ì„œ ì¶”ì²œ ëŒ€ìƒ ì„ íƒ)</h3>
      <div id="places"></div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #f0f4fb">
      <div id="route-box" style="display:none">
        <h4>ì¶”ì²œ ë£¨íŠ¸</h4>
        <ol id="route-list" class="route-list"></ol>
        <div id="route-summary"></div>
      </div>
    </aside>
  </div>
</div>

<footer>ë°ëª¨: ì œê³µí•˜ì‹  XML ë°ì´í„°ë¡œ ì‘ë™í•©ë‹ˆë‹¤. ì´ë¯¸ì§€ê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ httpâ†’https ì œí•œ ë•Œë¬¸ì…ë‹ˆë‹¤.</footer>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   ë°ì´í„° (ì „ì²´ XML)
   ========================= */
const xmlText = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><response><header>
  <resultCode>0000</resultCode>
  <resultMsg>OK</resultMsg>
</header><body><items>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì‹ ì„œë©´ ëŒ€ê´‘ë¦¬</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010400</cat3>
    <contentid>127163</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20030327090000</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/95/3537495_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/95/3537495_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>127.1674160678</mapx>
    <mapy>38.1977562930</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250915191415</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ê³ ëŒ€ì‚°</title>
    <zipcode>11000</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì‹ ì„œë©´ ê³ ëŒ€ì‚°ê¸¸ 84-79</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010600</cat3>
    <contentid>3018261</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20231005172754</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/03/3002903_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/03/3002903_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>127.1506644287</mapx>
    <mapy>38.2113155104</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250701170813</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ê³ ëŒ€ì‚°ìì—°íœ´ì–‘ë¦¼</title>
    <zipcode>11001</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì—°ì²œì ë™ë§‰ë¦¬</addr1>
    <addr2>198</addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010500</cat3>
    <contentid>2616251</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20190822014513</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/54/3518754_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/54/3518754_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type1</cpyrhtDivCd>
    <mapx>127.1114269423</mapx>
    <mapy>38.0969003950</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250808135854</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ë™ë§‰ê³¨ ì‘íšŒì•” (í•œíƒ„ê°• ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ì§€ì§ˆê³µì›)</title>
    <zipcode>11011</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì—°ì²œì ê³ ë¬¸ë¦¬</addr1>
    <addr2>212</addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010500</cat3>
    <contentid>2616492</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20190826231730</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/39/3537539_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/39/3537539_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>127.1174163087</mapx>
    <mapy>38.0617546108</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250915193512</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ë°±ì˜ë¦¬ì¸µ (í•œíƒ„ê°• ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ì§€ì§ˆê³µì›)</title>
    <zipcode>11018</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì‹ ì„œë©´ í‰í™”ë¡œ 3282-76</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010500</cat3>
    <contentid>2735336</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20210819234618</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/81/3382281_image2_1.JPG</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/81/3382281_image3_1.JPG</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>127.1612210451</mapx>
    <mapy>38.2366849576</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250319175910</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ì—­ê³ ë“œë¦„</title>
    <zipcode>11001</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì²­ì‚°ë©´ ì´ˆì„±ë¦¬</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010900</cat3>
    <contentid>128044</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20040225090000</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/47/3537547_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/47/3537547_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>127.0853157997</mapx>
    <mapy>37.9894541362</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250915194510</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ì—´ë‘ê°œìš¸</title>
    <zipcode>11023</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì „ê³¡ì ì€ëŒ€ë¦¬</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010500</cat3>
    <contentid>2616500</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20190826233449</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/97/2616497_image2_1.bmp</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/97/2616497_image2_1.bmp</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>127.0564445744</mapx>
    <mapy>38.0461581003</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250320134352</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ì€ëŒ€ë¦¬ íŒìƒì ˆë¦¬ì™€ ìŠµê³¡êµ¬ì¡° (í•œíƒ„ê°• ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ì§€ì§ˆê³µì›)</title>
    <zipcode>11024</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì¤‘ë©´ ì‚¼ê³¶ë¦¬</addr1>
    <addr2>422</addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010700</cat3>
    <contentid>2841245</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20220823100353</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/95/3092295_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/95/3092295_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type1</cpyrhtDivCd>
    <mapx>127.0171734736</mapx>
    <mapy>38.1313446498</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250904155051</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ì„ì§„ê°• ëŒ‘ì‹¸ë¦¬ì •ì›</title>
    <zipcode>11004</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ë¯¸ì‚°ë©´ ë™ì´ë¦¬</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010500</cat3>
    <contentid>2569474</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20181124225643</createdtime>
    <firstimage></firstimage>
    <firstimage2></firstimage2>
    <cpyrhtDivCd></cpyrhtDivCd>
    <mapx>127.0154490945</mapx>
    <mapy>38.0199326406</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250318143252</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ì„ì§„ê°• ì£¼ìƒì ˆë¦¬ (í•œíƒ„ê°• ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ì§€ì§ˆê³µì›)</title>
    <zipcode>11047</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì¤‘ë©´ íš¡ì‚°ë¦¬ 224</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010500</cat3>
    <contentid>2569460</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20181124033008</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/54/2563654_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/54/2563654_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>126.9873487890</mapx>
    <mapy>38.1191510887</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20241204160609</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ì„ì§„ê°•í‰í™”ìŠµì§€ì›</title>
    <zipcode>11004</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì—°ì²œì ë¶€ê³¡ë¦¬ 192</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010800</cat3>
    <contentid>125496</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20040225090000</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/05/3532805_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/05/3532805_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type1</cpyrhtDivCd>
    <mapx>127.1427246484</mapx>
    <mapy>38.0772227105</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250909173100</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ì¬ì¸í­í¬ (í•œíƒ„ê°• ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ì§€ì§ˆê³µì›)</title>
    <zipcode>11018</zipcode>
  </item>
  <item>
    <addr1>ê²½ê¸°ë„ ì—°ì²œêµ° ì—°ì²œì ê³ ë¬¸ë¦¬</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010800</cat3>
    <contentid>2843976</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20220825100444</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/38/2843938_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/38/2843938_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>127.1413164638</mapx>
    <mapy>38.0765560961</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250702091117</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>ì¬ì¸í­í¬ ì¶œë ë‹¤ë¦¬</title>
    <zipcode>11018</zipcode>
  </item>
</items>  <numOfRows>12</numOfRows>
  <pageNo>1</pageNo>
  <totalCount>15</totalCount>
</body></response>`;

/* =========================
   íŒŒì‹± + ë°ì´í„°
   ========================= */
function parseXMLToPlaces(xmlStr){
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlStr, 'application/xml');
  const items = Array.from(doc.getElementsByTagName('item'));
  return items.map(it=>{
    const g = tag => {
      const el = it.getElementsByTagName(tag)[0];
      return el ? el.textContent.trim() : '';
    };
    let img = g('firstimage') || '';
    if (img && img.startsWith('http://')) img = img.replace('http://','https://');
    const lon = parseFloat(g('mapx')||NaN);
    const lat = parseFloat(g('mapy')||NaN);
    return {
      id: g('contentid') || (Math.random()+''),
      name: g('title') || 'ë¬´ì œ',
      addr: g('addr1') || '',
      lat: isFinite(lat)?lat:null,
      lon: isFinite(lon)?lon:null,
      img
    };
  }).filter(p=>p.lat && p.lon);
}

/* =========================
   ì§€ë„ ì´ˆê¸°í™” (ëª¨ë“  ë§ˆì»¤ ì´ˆê¸°ì— í‘œì‹œ)
   ========================= */
const places = parseXMLToPlaces(xmlText);
const map = L.map('map').setView([38.06,127.06], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
let markers = {}; // id -> marker
let routeLine = null;

/* =========================
   ë Œë”ë§: ë¦¬ìŠ¤íŠ¸ + ë§ˆì»¤(ì´ˆê¸° ìƒì„±)
   ========================= */
function renderPlaceList(){
  const container = document.getElementById('places'); container.innerHTML='';
  places.forEach(p=>{
    const el = document.createElement('div'); el.className='place';
    el.dataset.id = p.id;
    el.innerHTML = `
      <input type="checkbox" data-id="${p.id}" style="width:18px;height:18px;margin-right:8px">
      <img src="${p.img || 'https://via.placeholder.com/320x240?text=No+Image'}" alt="${escapeHtml(p.name)}" onerror="this.src='https://via.placeholder.com/320x240?text=No+Image'">
      <div class="meta"><b>${escapeHtml(p.name)}</b><div class="small">${escapeHtml(p.addr)}</div></div>
    `;
    el.addEventListener('click', (e) => {
      if (e.target.tagName === 'INPUT') { updateRecommendButton(); updateStartSelect(); return; }
      focusMarker(p.id);
    });
    container.appendChild(el);
  });
  places.forEach(p => ensureMarker(p.id));
  updateStartSelect();
  updateRecommendButton();
}

/* ë§ˆì»¤ ìƒì„± */
function ensureMarker(id){
  if (markers[id]) return markers[id];
  const p = places.find(x => x.id === id);
  if (!p) return null;
  const m = L.marker([p.lat, p.lon]).addTo(map);
  const imgHtml = p.img ? `<br><img src="${p.img}" style="width:160px;border-radius:6px;margin-top:6px" onerror="this.style.display='none'">` : '';
  m.bindPopup(`<strong>${escapeHtml(p.name)}</strong><br>${escapeHtml(p.addr)}${imgHtml}`);
  m.on('click', ()=> {
    const card = document.querySelector(`#places .place[data-id="${id}"]`);
    if (card){ card.scrollIntoView({behavior:'smooth',block:'center'}); card.style.boxShadow='0 2px 14px rgba(11,99,184,0.12)'; setTimeout(()=>card.style.boxShadow='',900); }
  });
  markers[id] = m;
  return m;
}

/* í¬ì»¤ìŠ¤ (ì „ì—­ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ) */
function focusMarker(id){
  const m = ensureMarker(id);
  if (m){ map.setView(m.getLatLng(), 13); m.openPopup(); }
}
window.focusMarker = focusMarker;

/* =========================
   ì„ íƒ/ì¶”ì²œ ê´€ë ¨ (ì „ì—­ ë…¸ì¶œ)
   ========================= */
function getCheckedPlaces(){
  const checks = Array.from(document.querySelectorAll('#places input[type=checkbox]')).filter(c=>c.checked);
  return checks.map(c=>places.find(p=>p.id===c.dataset.id)).filter(Boolean);
}
window.getCheckedPlaces = getCheckedPlaces;

function updateRecommendButton(){
  const selected = getCheckedPlaces();
  const btn = document.getElementById('btn-recommend');
  btn.disabled = selected.length < 2;
}
window.updateRecommendButton = updateRecommendButton;

function updateStartSelect(){
  const sel = document.getElementById('start-select'); sel.innerHTML='';
  const selected = getCheckedPlaces();
  selected.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.text=p.name; sel.appendChild(o); });
  if (sel.options.length===0){
    places.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.text=p.name; sel.appendChild(o); });
  }
}
window.updateStartSelect = updateStartSelect;

document.getElementById('btn-select-all').addEventListener('click', ()=>{
  document.querySelectorAll('#places input[type=checkbox]').forEach(i=>i.checked=true);
  updateRecommendButton(); updateStartSelect();
});
document.getElementById('btn-clear-all').addEventListener('click', ()=>{
  document.querySelectorAll('#places input[type=checkbox]').forEach(i=>i.checked=false);
  updateRecommendButton(); updateStartSelect();
});
document.getElementById('places').addEventListener('change', (e)=> { if (e.target && e.target.matches('input[type=checkbox]')) updateRecommendButton(); });

/* ê²€ìƒ‰ */
document.getElementById('btn-search').addEventListener('click', ()=> {
  const q = document.getElementById('q').value.trim().toLowerCase();
  if(!q) return alert('ê²€ìƒ‰ì–´ ì…ë ¥');
  const found = places.find(p => p.name.toLowerCase().includes(q) || p.addr.toLowerCase().includes(q));
  if(!found) return alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
  focusMarker(found.id);
  const el = document.querySelector(`#places .place[data-id="${found.id}"]`);
  if (el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.style.boxShadow='0 2px 16px rgba(11,99,184,0.12)'; setTimeout(()=>el.style.boxShadow='',1200); }
});

/* =========================
   ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ (Nearest Neighbor) + ê²½ë¡œ ê·¸ë¦¬ê¸°(ë¹¨ê°„ìƒ‰)
   + ì´ ê±°ë¦¬ ë° ì´ ì†Œìš”ì‹œê°„(ë„ë³´/ìì „ê±°/ìì°¨)
   ========================= */
const SPEED = { car: 60, bike: 15, walk: 4 }; // km/h (í‰ê· ì†ë„ ê°€ì •)

function haversine(a,b){
  const toRad = v => v*Math.PI/180;
  const R = 6371;
  const dLat = toRad(b.lat-a.lat), dLon = toRad(b.lon-a.lon);
  const la = toRad(a.lat), lb = toRad(b.lat);
  const A = Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
}

async function recommend(){
  let selected = getCheckedPlaces();
  if (selected.length < 2) return alert('ìµœì†Œ 2ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.');
  let startObj = null;

  if (document.getElementById('start-mode').value === 'current'){
    try {
      const pos = await new Promise((res,rej)=>{
        navigator.geolocation.getCurrentPosition(p=>res(p),e=>rej(e), {enableHighAccuracy:true, timeout:10000});
      });
      startObj = { id:'__me', name:'í˜„ì¬ìœ„ì¹˜', lat: pos.coords.latitude, lon: pos.coords.longitude };
    } catch(e){
      return alert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œ í™•ì¸í•˜ì„¸ìš”.');
    }
  } else {
    const sid = document.getElementById('start-select').value;
    startObj = selected.find(p=>p.id===sid) || places.find(p=>p.id===sid);
    selected = selected.filter(p => p.id !== startObj.id);
  }

  // NN
  const route = [startObj];
  const rest = selected.slice();
  while(rest.length){
    const last = route[route.length-1];
    rest.sort((a,b) => haversine(last,a) - haversine(last,b));
    route.push(rest.shift());
  }

  drawRouteWithTimes(route);
}
window.recommend = recommend;

function drawRouteWithTimes(route){
  // remove existing route
  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }

  // ensure markers
  route.forEach(r=>{ if (r.id !== '__me') ensureMarker(r.id); });

  const latlngs = route.map(r=>[r.lat,r.lon]);
  // <-- **ë¹¨ê°„ìƒ‰ ì„ ** -->
  routeLine = L.polyline(latlngs, {color:'red', weight:5, opacity:0.95}).addTo(map);
  map.fitBounds(routeLine.getBounds().pad(0.15));

  // ì´ ê±°ë¦¬
  let total = 0;
  for (let i=1;i<route.length;i++){
    total += haversine(route[i-1], route[i]);
  }

  // ì´ ì‹œê°„ ê³„ì‚°(ê° ì´ë™ìˆ˜ë‹¨)
  const totals = {};
  for (const k of Object.keys(SPEED)){
    const hours = total / SPEED[k];
    totals[k] = { hours, mins: Math.round(hours*60) };
  }

  // ê° êµ¬ê°„ ë³„ ê±°ë¦¬/ì‹œê°„(ì„ íƒ í•­ëª©ë³„ ìƒì„¸)ì€ ê¸°ì¡´ í•­ëª© í‘œì‹œë¡œ ìœ ì§€
  const ol = document.getElementById('route-list'); ol.innerHTML='';
  for (let i=0;i<route.length;i++){
    const li = document.createElement('li');
    if (i===0){
      li.textContent = `1. ì¶œë°œ â€” ${route[i].name}`;
    } else {
      const d = haversine(route[i-1], route[i]);
      li.innerHTML = `${i+1}. ${escapeHtml(route[i].name)} <div style="font-size:13px;color:#444;margin-top:6px">ê±°ë¦¬: <strong>${d.toFixed(2)} km</strong></div>`;
    }
    li.addEventListener('click', ()=> { if(route[i].id === '__me') map.setView([route[i].lat,route[i].lon],13); else focusMarker(route[i].id); });
    ol.appendChild(li);
  }

  // ìš”ì•½ í‘œì‹œ (ì´ ê±°ë¦¬ + ê° ì´ë™ìˆ˜ë‹¨ ì´ ì‹œê°„)
  const sumBox = document.getElementById('route-summary');
  sumBox.innerHTML = `
    <div><strong>ì´ ê±°ë¦¬:</strong> ${total.toFixed(2)} km</div>
    <div style="margin-top:8px">
      <div>ğŸš¶ ë„ë³´: <strong>${totals.walk.mins} ë¶„</strong> (${totals.walk.hours.toFixed(2)} ì‹œê°„)</div>
      <div>ğŸš´ ìì „ê±°: <strong>${totals.bike.mins} ë¶„</strong> (${totals.bike.hours.toFixed(2)} ì‹œê°„)</div>
      <div>ğŸš— ìì°¨: <strong>${totals.car.mins} ë¶„</strong> (${totals.car.hours.toFixed(2)} ì‹œê°„)</div>
    </div>
  `;
  document.getElementById('route-box').style.display = 'block';
}

/* clear route */
document.getElementById('btn-clear-route').addEventListener('click', ()=>{
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  if (markers['__me']) { map.removeLayer(markers['__me']); delete markers['__me']; }
  document.getElementById('route-box').style.display='none';
});
document.getElementById('btn-recommend').addEventListener('click', ()=> recommend());

/* init */
renderPlaceList();

/* helpers */
function formatMinutes(mins){ if(mins<60) return `${mins} ë¶„`; const h=Math.floor(mins/60); const m=mins%60; return `${h}ì‹œê°„ ${m}ë¶„`; }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
</script>

<!-- ========== ê°„ë‹¨í•œ ì±—ë´‡ (ë¶ˆí•„ìš” ë¬¸êµ¬ ì •ë¦¬) ========== -->
<style>
#chatbot-btn { position: fixed; right: 22px; bottom: 22px; z-index: 99999;
  width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#0B63B8,#2E8B57);
  color:#fff;border:none;box-shadow:0 6px 18px rgba(11,99,184,0.18);cursor:pointer;font-size:20px }
#chatbot-panel { position: fixed; right: 22px; bottom: 86px; z-index: 99999;
  width:340px; max-height:62vh; background:#fff; border-radius:12px; box-shadow:0 12px 30px rgba(8,40,70,0.12);
  display:none; flex-direction:column; overflow:hidden; font-family: "Noto Sans KR", sans-serif; }
#chatbot-header { padding:12px 14px; background:linear-gradient(90deg,#0B63B8,#2E8B57); color:#fff; }
#chatbot-messages { padding:12px; overflow:auto; flex:1; }
.msg { margin-bottom:10px; max-width:86%; line-height:1.4; }
.msg.bot { background:#f1f6ff; color:#1b2838; padding:10px 12px; border-radius:10px; }
.msg.user { margin-left:auto; background:#0B63B8; color:#fff; padding:8px 12px; border-radius:10px; }
#chatbot-input { display:flex; gap:8px; padding:10px; border-top:1px solid #eee; }
#chatbot-input input { flex:1; padding:9px;border-radius:8px;border:1px solid #e6eef9 }
#chatbot-input button { padding:8px 10px;border-radius:8px;border:none;background:#0B63B8;color:#fff;cursor:pointer }
.small-muted { font-size:12px;color:#666;margin-top:6px }
</style>

<button id="chatbot-btn" title="ì±—ë´‡ ì—´ê¸°">ğŸ’¬</button>

<div id="chatbot-panel" role="dialog" aria-label="ì±—ë´‡">
  <div id="chatbot-header"><strong>ì—°ì²œ ì•ˆë‚´ ì±—ë´‡</strong><div style="font-size:12px;opacity:.9">ê´€ê´‘ì§€ ê²€ìƒ‰ Â· ë£¨íŠ¸ ìƒì„± ì§€ì›</div></div>
  <div id="chatbot-messages"></div>
  <div id="chatbot-input">
    <input id="chatbot-text" placeholder="ì˜ˆ: 'ì¬ì¸í­í¬ ì•Œë ¤ì¤˜', 'Aì™€ B ì¶”ì²œí•´ì¤˜'">
    <button id="chatbot-send">ë³´ë‚´ê¸°</button>
  </div>
</div>

<script>
(function(){
  const btn = document.getElementById('chatbot-btn');
  const panel = document.getElementById('chatbot-panel');
  const messages = document.getElementById('chatbot-messages');
  const input = document.getElementById('chatbot-text');
  const send = document.getElementById('chatbot-send');

  const PLACES = window.places || [];

  btn.addEventListener('click', ()=> panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex');
  panel.style.display = 'none';
  panel.style.flexDirection = 'column';

  function pushUser(text){
    const d = document.createElement('div'); d.className='msg user'; d.textContent = text;
    messages.appendChild(d); messages.scrollTop = messages.scrollHeight;
  }
  function pushBot(html){
    const d = document.createElement('div'); d.className='msg bot'; d.innerHTML = html;
    messages.appendChild(d); messages.scrollTop = messages.scrollHeight;
  }

  pushBot("ì•ˆë…•í•˜ì„¸ìš” â€” ê´€ê´‘ì§€ ê²€ìƒ‰ê³¼ ì„ íƒ ê¸°ë°˜ ì¶”ì²œë£¨íŠ¸ë¥¼ ë„ì™€ë“œë¦½ë‹ˆë‹¤.");

  function handleText(raw){
    const text = (raw||'').trim();
    if(!text) { pushBot('ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?'); return; }
    pushUser(text);
    const lower = text.toLowerCase();

    if (/^(ì•ˆë…•|ì•ˆë…•í•˜ì„¸ìš”|hi|hello)/i.test(lower)) {
      pushBot('ì•ˆë…•í•˜ì„¸ìš”. ê´€ê´‘ì§€ ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜ "Aì™€ B ì¶”ì²œí•´ì¤˜"ì²˜ëŸ¼ ë§í•´ë³´ì„¸ìš”.');
      return;
    }

    if (/ì¶”ì²œ|ë£¨íŠ¸|ê²½ë¡œ|ì½”ìŠ¤/.test(lower)) {
      const mentioned = findPlacesInText(lower);
      if (mentioned.length >= 2) {
        // ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒ í›„ ì¶”ì²œ íŠ¸ë¦¬ê±° (ë¶ˆí•„ìš” ë¬¸êµ¬ ì œê±°: ê°„ê²°íˆ ì²˜ë¦¬)
        const allChecks = document.querySelectorAll('#places input[type=checkbox]');
        allChecks.forEach(cb => { cb.checked = mentioned.some(p=>p.id===cb.dataset.id); });
        if (typeof updateRecommendButton === 'function') updateRecommendButton();
        if (typeof updateStartSelect === 'function') updateStartSelect();
        const recommendBtn = document.getElementById('btn-recommend');
        if (recommendBtn && !recommendBtn.disabled) { recommendBtn.click(); pushBot('ì¶”ì²œë£¨íŠ¸ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.'); }
        else pushBot('ì¶”ì²œì„ ì‹¤í–‰í•˜ë ¤ë©´ 2ê°œ ì´ìƒ ì„ íƒë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      const selected = (typeof getCheckedPlaces === 'function') ? getCheckedPlaces() : [];
      if (selected.length >= 2) {
        document.getElementById('btn-recommend').click();
        pushBot('ì„ íƒëœ ì¥ì†Œë¡œ ì¶”ì²œë£¨íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.');
      } else {
        pushBot('ì¥ì†Œë¥¼ 2ê³³ ì´ìƒ ì§€ì •í•´ì£¼ì„¸ìš” (ì˜ˆ: "ì¬ì¸í­í¬ì™€ ì„ì§„ê°• ì¶”ì²œ").');
      }
      return;
    }

    if (/ì•Œë ¤ì¤˜|ì •ë³´|ìœ„ì¹˜|ì£¼ì†Œ|ì „í™”|ì‚¬ì§„|ì´ë¯¸ì§€/.test(lower)) {
      const matches = findPlacesInText(lower);
      if (matches.length===0) {
        const substr = lower.replace(/(ì•Œë ¤ì¤˜|ì •ë³´|ìœ„ì¹˜|ì£¼ì†Œ|ì „í™”|ì‚¬ì§„|ì´ë¯¸ì§€)/g,'').trim();
        if (substr.length >= 2) {
          const approx = PLACES.filter(p => (p.name||'').toLowerCase().includes(substr) || (p.addr||'').toLowerCase().includes(substr));
          if (approx.length) return pushBot(renderPlaceListHtml(approx.slice(0,6)));
        }
        return pushBot('ì¥ì†Œëª…ì„ ì¢€ ë” ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”. ì˜ˆ: "ì¬ì¸í­í¬"');
      }
      return pushBot(renderPlaceListHtml(matches));
    }

    if (/ê¸¸ì°¾ê¸°|ê°€ëŠ” ë°©ë²•|ê°€ëŠ” ë²•|ì–´ë–»ê²Œ ê°€/.test(lower)) {
      const matches = findPlacesInText(lower);
      if (matches.length>=1) {
        const m = matches[0];
        const url = `https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lon}`;
        pushBot(`"${m.name}" ê¸¸ì°¾ê¸°: <a class="chat-link" target="_blank" href="${url}">ì—´ê¸°</a>`);
      } else pushBot('ê¸¸ì°¾ê¸°í•˜ë ¤ë©´ ì¥ì†Œëª…ì„ í¬í•¨í•´ ì£¼ì„¸ìš”.');
      return;
    }

    // ê¸°ë³¸ í¼ì§€ ê²€ìƒ‰
    const fuzzy = PLACES.filter(p => (p.name||'').toLowerCase().includes(lower) || (p.addr||'').toLowerCase().includes(lower));
    if (fuzzy.length) return pushBot(renderPlaceListHtml(fuzzy.slice(0,6)));

    pushBot('ì˜ ì´í•´í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¥ì†Œëª…ì´ë‚˜ "A,B ì¶”ì²œ" í˜•íƒœë¡œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
  }

  function findPlacesInText(text){
    const results = [];
    for (const p of PLACES){
      const n = (p.name||'').toLowerCase();
      if (!n) continue;
      if ((' '+text+' ').includes(' '+n+' ')) { results.push(p); continue; }
      if (text.includes(n)) { results.push(p); continue; }
      const toks = n.split(/\s+/)[0];
      if (toks && toks.length>=3 && text.includes(toks)) results.push(p);
    }
    return results.filter((v,i,self)=> self.findIndex(x=>x.id===v.id)===i);
  }

  function renderPlaceListHtml(arr){
    if (!arr || arr.length===0) return 'ê´€ë ¨ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.';
    return arr.map(p=> {
      const img = p.img ? `<div style="margin-top:6px"><img src="${p.img}" style="width:100%;border-radius:6px" onerror="this.style.display=\\'none\\'"></div>` : '';
      return `<div style="margin-bottom:8px"><strong>${escapeHtml(p.name)}</strong><div class="small-muted">${escapeHtml(p.addr)}</div>${img}
        <div style="margin-top:6px"><a class="chat-link" href="#" data-id="${p.id}" onclick="(function(e){e.preventDefault();const id=this.getAttribute('data-id');window.focusMarker && window.focusMarker(id);})();return false">ì§€ë„ë¡œ ë³´ê¸°</a></div></div>`;
    }).join('<hr style="margin:8px 0">');
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

  send.addEventListener('click', ()=> { const v=input.value; input.value=''; handleText(v); });
  input.addEventListener('keydown', (e)=> { if(e.key==='Enter'){ e.preventDefault(); send.click(); } });
})();
</script>

</body>
</html>
