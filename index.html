<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>연천군 관광지 — 선택 기반 추천 코스 (마커 지연표시, 이동수단)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{--primary:#0B63B8;--muted:#F1F6F9;--card:#fff;--text:#222}
  *{box-sizing:border-box} body{font-family:"Noto Sans KR",sans-serif;margin:0;background:#f7fbff;color:var(--text)}
  header{background:linear-gradient(135deg,var(--primary),#2E8B57);color:#fff;padding:20px 16px;text-align:center}
  header h1{margin:0;font-size:1.2rem}
  .wrap{max-width:1200px;margin:18px auto;padding:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,0.08)}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .layout{display:grid;grid-template-columns:1fr 380px;gap:12px}
  #map{height:680px;border-radius:12px;border:1px solid rgba(0,0,0,0.06)}
  .panel{background:var(--card);padding:12px;border-radius:12px;height:680px;overflow:auto;border:1px solid rgba(0,0,0,0.04)}
  .search{display:flex;gap:8px;margin-bottom:10px}
  input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef9}
  .place{display:flex;gap:10px;padding:8px;border-radius:8px;border:1px solid #f0f4fb;align-items:center;margin-bottom:8px;cursor:pointer}
  .place img{width:84px;height:56px;object-fit:cover;border-radius:6px}
  .place .meta{flex:1}
  .place .meta b{display:block;color:var(--primary)}
  .small{font-size:13px;color:#666}
  .route-list li{padding:8px;background:var(--muted);border-radius:8px;margin-bottom:6px;list-style:none}
  .mode-select{padding:8px;border-radius:8px;border:1px solid #eee}
  footer{max-width:1200px;margin:18px auto;text-align:center;color:#666;font-size:13px}
  @media(max-width:980px){.layout{grid-template-columns:1fr} .panel{height:auto} #map{height:420px}}
</style>
</head>
<body>
<header>
  <h1>연천군 관광지 — 선택 기반 추천 코스</h1>
  <div style="font-size:13px;opacity:.95">마커는 처음엔 보이지 않습니다. 목록에서 장소를 누르면 해당 장소의 마커가 생깁니다.</div>
</header>

<div class="wrap">
  <div class="controls">
    <button id="btn-select-all" class="btn ghost">전체선택</button>
    <button id="btn-clear-all" class="btn ghost">선택해제</button>

    <label style="display:flex;gap:8px;align-items:center">
      <span class="small">이동수단</span>
      <select id="mode" class="mode-select">
        <option value="car">자차 (자동차)</option>
        <option value="bike">자전거</option>
        <option value="walk">도보</option>
      </select>
    </label>

    <button id="btn-recommend" class="btn" disabled>추천 루트 생성</button>
    <button id="btn-clear-route" class="btn ghost">루트 지우기</button>

    <label style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <select id="start-mode" style="padding:8px;border-radius:8px;border:1px solid #eee">
        <option value="pick">선택한 장소 중에서 시작</option>
        <option value="current">현재 위치에서 시작</option>
      </select>
    </label>

    <label style="display:flex;gap:6px;align-items:center">
      <span class="small">시작지:</span>
      <select id="start-select" style="padding:8px;border-radius:8px;border:1px solid #eee"></select>
    </label>
  </div>

  <div class="layout">
    <div id="map"></div>

    <aside class="panel">
      <div class="search">
        <input id="q" placeholder="검색 (장소명 / 주소 포함)"/>
        <button id="btn-search" class="btn ghost">검색</button>
      </div>

      <h3 style="margin:6px 0">관광지 목록 (클릭하면 지도에 마커 생성 / 체크해서 선택)</h3>
      <div id="places"></div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #f0f4fb">
      <div id="route-box" style="display:none">
        <h4>추천 루트</h4>
        <ol id="route-list" class="route-list"></ol>
        <div style="margin-top:8px">총 이동거리(직선 합): <b id="total-dist">0 km</b></div>
      </div>
    </aside>
  </div>
</div>

<footer>데모: API 없이 제공된 XML을 사용합니다. 시간 추정은 직선거리·평균속도로 계산됩니다.</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ---------------------------
   데이터 (당신이 제공한 XML 전체를 여기에 넣으세요)
   --------------------------- */
const xmlText = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><response><header>
  <resultCode>0000</resultCode>
  <resultMsg>OK</resultMsg>
</header><body><items>
  <item>
    <addr1>경기도 연천군 신서면 대광리</addr1>
    <addr2></addr2>
    <areacode>31</areacode>
    <cat1>A01</cat1>
    <cat2>A0101</cat2>
    <cat3>A01010400</cat3>
    <contentid>127163</contentid>
    <contenttypeid>12</contenttypeid>
    <createdtime>20030327090000</createdtime>
    <firstimage>http://tong.visitkorea.or.kr/cms/resource/95/3537495_image2_1.jpg</firstimage>
    <firstimage2>http://tong.visitkorea.or.kr/cms/resource/95/3537495_image3_1.jpg</firstimage2>
    <cpyrhtDivCd>Type3</cpyrhtDivCd>
    <mapx>127.1674160678</mapx>
    <mapy>38.1977562930</mapy>
    <mlevel>6</mlevel>
    <modifiedtime>20250915191415</modifiedtime>
    <sigungucode>21</sigungucode>
    <tel></tel>
    <title>고대산</title>
    <zipcode>11000</zipcode>
  </item>
  <!-- (중략) ... 나머지 item 태그들 모두 여기에 그대로 넣으세요 -->
</items>  <numOfRows>12</numOfRows>
  <pageNo>1</pageNo>
  <totalCount>15</totalCount>
</body></response>`;

/* ---------------------------
   파싱 + 기본 데이터 구조
   --------------------------- */
function parseXMLToPlaces(xmlStr){
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlStr, 'application/xml');
  const items = Array.from(doc.getElementsByTagName('item'));
  return items.map(it=>{
    const g = tag => {
      const el = it.getElementsByTagName(tag)[0];
      return el ? el.textContent.trim() : '';
    };
    let img = g('firstimage') || '';
    if (img && img.startsWith('http://')) img = img.replace('http://','https://');
    const lon = parseFloat(g('mapx')||NaN);
    const lat = parseFloat(g('mapy')||NaN);
    return {
      id: g('contentid') || (Math.random()+''),
      name: g('title') || '무제',
      addr: g('addr1') || '',
      lat: isFinite(lat)?lat:null,
      lon: isFinite(lon)?lon:null,
      img
    };
  }).filter(p=>p.lat && p.lon);
}

/* ---------------------------
   지도 초기화 (빈 상태 — 마커 없음)
   --------------------------- */
const places = parseXMLToPlaces(xmlText);
const map = L.map('map').setView([38.06,127.06], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
let markers = {}; // id -> marker (생성된 것만 저장)
let routeLine = null;

/* ---------------------------
   렌더링: 장소 목록 (마커는 생성하지 않음)
   - 카드 클릭 시 해당 장소 마커를 생성하고 팝업 오픈
   - 체크박스로 선택(추천 대상) 가능
   --------------------------- */
function renderPlaceList(){
  const container = document.getElementById('places'); container.innerHTML='';
  places.forEach(p=>{
    const el = document.createElement('div'); el.className='place';
    el.dataset.id = p.id;
    el.innerHTML = `
      <input type="checkbox" data-id="${p.id}" style="width:18px;height:18px;margin-right:8px">
      <img src="${p.img || 'https://via.placeholder.com/320x240?text=No+Image'}" alt="${escapeHtml(p.name)}" onerror="this.src='https://via.placeholder.com/320x240?text=No+Image'">
      <div class="meta"><b>${escapeHtml(p.name)}</b><div class="small">${escapeHtml(p.addr)}</div></div>
    `;
    // 클릭하면 마커 생성 & 토글 체크박스는 따로
    el.addEventListener('click', (e) => {
      // 클릭 대상이 체크박스면 체크 토글만 처리(마커 생성은 별도로 클릭해도 동작)
      if (e.target.tagName === 'INPUT') {
        updateRecommendButton();
        updateStartSelect();
        return;
      }
      const cb = el.querySelector('input[type=checkbox]');
      // 마커 생성/토글(카드 클릭 시 마커 생성 및 팝업)
      ensureMarker(p.id);
      // 포커스
      focusMarker(p.id);
      // 클릭하면 체크박스 상태는 변경하지 않음 — 사용자가 직접 체크해서 선택하도록 둠.
    });
    container.appendChild(el);
  });
  updateStartSelect();
  updateRecommendButton();
}

/* 마커 생성 함수 — 이미 있으면 재사용 */
function ensureMarker(id){
  if (markers[id]) return markers[id];
  const p = places.find(x => x.id === id);
  if (!p) return null;
  const m = L.marker([p.lat, p.lon]).addTo(map);
  const imgHtml = p.img ? `<br><img src="${p.img}" style="width:160px;border-radius:6px;margin-top:6px" onerror="this.style.display='none'">` : '';
  m.bindPopup(`<strong>${escapeHtml(p.name)}</strong><br>${escapeHtml(p.addr)}${imgHtml}`);
  markers[id] = m;
  return m;
}
function focusMarker(id){
  const m = ensureMarker(id);
  if (m) {
    map.setView(m.getLatLng(), 13);
    m.openPopup();
  }
}

/* ---------------------------
   선택(체크박스) 관련
   - 추천 버튼은 선택 수가 2개 이상일 때만 활성화
   --------------------------- */
function getCheckedPlaces(){
  const checks = Array.from(document.querySelectorAll('#places input[type=checkbox]')).filter(c=>c.checked);
  return checks.map(c=>places.find(p=>p.id===c.dataset.id)).filter(Boolean);
}
function updateRecommendButton(){
  const selected = getCheckedPlaces();
  const btn = document.getElementById('btn-recommend');
  btn.disabled = selected.length < 2;
}
function updateStartSelect(){
  const sel = document.getElementById('start-select'); sel.innerHTML='';
  const selected = getCheckedPlaces();
  selected.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.text=p.name; sel.appendChild(o); });
  if (sel.options.length===0){
    places.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.text=p.name; sel.appendChild(o); });
  }
}

/* 전체선택/해제 버튼 */
document.getElementById('btn-select-all').addEventListener('click', ()=>{
  document.querySelectorAll('#places input[type=checkbox]').forEach(i=>i.checked=true);
  updateRecommendButton(); updateStartSelect();
});
document.getElementById('btn-clear-all').addEventListener('click', ()=>{
  document.querySelectorAll('#places input[type=checkbox]').forEach(i=>i.checked=false);
  updateRecommendButton(); updateStartSelect();
});

/* 검색 */
document.getElementById('btn-search').addEventListener('click', ()=> {
  const q = document.getElementById('q').value.trim().toLowerCase();
  if(!q) return alert('검색어 입력');
  const found = places.find(p => p.name.toLowerCase().includes(q) || p.addr.toLowerCase().includes(q));
  if(!found) return alert('검색 결과가 없습니다.');
  // ensure marker and focus
  ensureMarker(found.id); focusMarker(found.id);
  // highlight element briefly
  const el = document.querySelector(`#places .place[data-id="${found.id}"]`);
  if (el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.style.boxShadow='0 2px 16px rgba(11,99,184,0.12)'; setTimeout(()=>el.style.boxShadow='',1000); }
});

/* ---------------------------
   추천 알고리즘(Nearest Neighbor) + 이동수단별 시간계산
   - 이동수단별 평균 속도 (km/h)
   --------------------------- */
const SPEED = { car: 50, bike: 15, walk: 5 }; // 필요하면 조정

function haversine(a,b){
  const toRad = v => v*Math.PI/180;
  const R = 6371;
  const dLat = toRad(b.lat-a.lat), dLon = toRad(b.lon-a.lon);
  const la = toRad(a.lat), lb = toRad(b.lat);
  const A = Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
}

async function recommend(){
  let selected = getCheckedPlaces();
  if (selected.length < 2) return alert('최소 2개 이상 선택하세요.');
  const mode = document.getElementById('mode').value;
  let startObj = null;

  if (document.getElementById('start-mode').value === 'current'){
    // 현재 위치
    try {
      const pos = await new Promise((res,rej)=>{
        navigator.geolocation.getCurrentPosition(p=>res(p),e=>rej(e), {enableHighAccuracy:true, timeout:10000});
      });
      startObj = { id:'__me', name:'현재위치', lat: pos.coords.latitude, lon: pos.coords.longitude };
    } catch(e){
      return alert('현재 위치를 사용할 수 없습니다. 권한 확인하세요.');
    }
  } else {
    const sid = document.getElementById('start-select').value;
    // 만약 시작지가 선택된 곳에 없으면 선택목록 대신 전체에서 찾음
    startObj = selected.find(p=>p.id===sid) || places.find(p=>p.id===sid);
    // remove start from selected copy to avoid duplication
    selected = selected.filter(p => p.id !== startObj.id);
  }

  // NN 알고리즘
  const route = [startObj];
  const rest = selected.slice();
  while(rest.length){
    const last = route[route.length-1];
    rest.sort((a,b) => haversine(last,a) - haversine(last,b));
    route.push(rest.shift());
  }

  // draw route and compute per-leg time
  drawRouteWithTimes(route, mode);
}

/* ---------------------------
   draw route: polyline + list with distance/time per leg
   --------------------------- */
function drawRouteWithTimes(route, mode){
  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
  // ensure markers for each place except current-user virtual one
  route.forEach(r => { if (r.id !== '__me') ensureMarker(r.id); else {
    // create a temporary marker for current location
    if (!markers['__me']) {
      markers['__me'] = L.circleMarker([r.lat,r.lon], {radius:7, color:'#ff5722', fillColor:'#ff8a50', fillOpacity:0.9}).addTo(map).bindPopup('현재 위치');
    } else {
      markers['__me'].setLatLng([r.lat,r.lon]);
    }
  }});

  const latlngs = route.map(r => [r.lat, r.lon]);
  routeLine = L.polyline(latlngs, {color:'#0B63B8', weight:5, opacity:0.9}).addTo(map);
  map.fitBounds(routeLine.getBounds().pad(0.15));

  const ol = document.getElementById('route-list'); ol.innerHTML='';
  let total = 0; let totalTime = 0;
  const spd = SPEED[mode] || 5;
  for (let i=0;i<route.length;i++){
    const li = document.createElement('li');
    const name = route[i].name;
    const addr = route[i].addr || '';
    if (i===0){
      li.textContent = `1. 출발 — ${name} ${addr ? ' — ' + addr : ''}`;
    } else {
      const d = haversine(route[i-1], route[i]); // km
      const tHours = d / spd;
      const mins = Math.round(tHours * 60);
      total += d; totalTime += tHours;
      li.innerHTML = `${i+1}. ${escapeHtml(route[i].name)} ${addr ? ' — ' + escapeHtml(addr) : ''} <div style="font-size:13px;color:#444;margin-top:6px">거리: <strong>${d.toFixed(2)} km</strong> · 예상 소요: <strong>${formatMinutes(mins)}</strong></div>`;
    }
    li.addEventListener('click', ()=> {
      if (route[i].id==='__me') { map.setView([route[i].lat, route[i].lon], 13); }
      else { focusMarker(route[i].id); }
    });
    ol.appendChild(li);
  }
  document.getElementById('total-dist').textContent = total.toFixed(2) + ' km';
  document.getElementById('route-box').style.display = 'block';
}

/* ---------------------------
   유틸: 포맷
   --------------------------- */
function formatMinutes(mins){
  if (mins < 60) return `${mins} 분`;
  const h = Math.floor(mins/60);
  const m = mins % 60;
  return `${h}시간 ${m}분`;
}

/* clear route */
document.getElementById('btn-clear-route').addEventListener('click', ()=>{
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  // remove temporary current location marker if any
  if (markers['__me']) { map.removeLayer(markers['__me']); delete markers['__me']; }
  document.getElementById('route-box').style.display='none';
});

/* bind recommend button (활성화 상태에 따라) */
document.getElementById('btn-recommend').addEventListener('click', ()=> recommend());

/* UI 업데이트: 체크박스 변화가 있을 때 Recommend 버튼 상태 갱신하도록 바인딩 (동적 요소이므로 event delegation) */
document.getElementById('places').addEventListener('change', (e)=> {
  if (e.target && e.target.matches('input[type=checkbox]')) updateRecommendButton();
});

/* 장소 클릭 시 (마커 생성/포커스) 처리는 renderPlaceList에서 이미 설정 */

/* init */
renderPlaceList();
updateRecommendButton();
updateStartSelect();

/* 유틸 */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

</script>
</body>
</html>
